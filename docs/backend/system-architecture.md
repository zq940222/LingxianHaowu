# 系统架构设计

## 一、技术架构

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                        用户层                             │
├──────────────┬──────────────┬────────────────────────────┤
│  用户端小程序  │  商家端小程序  │        PC后台              │
│  (Taro+React) │ (Taro+React) │    (Vue3+Element Plus)     │
└──────┬───────┴──────┬───────┴──────────┬─────────────────┘
       │              │                  │
       │ HTTPS/JWT    │ HTTPS/JWT        │ HTTPS/JWT
       │              │                  │
┌──────▼──────────────▼──────────────────▼─────────────────┐
│                      网关层 (可选)                        │
│              Nginx / API Gateway                         │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│                    应用服务层                              │
├───────────────────────────────────────────────────────────┤
│  FastAPI 应用服务                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  用户服务  │ 商品服务  │ 订单服务  │ 支付服务        │ │
│  │  积分服务  │ 活动服务  │ 配送服务  │ 消息服务        │ │
│  └─────────────────────────────────────────────────────┘ │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│                    数据访问层                              │
├───────────────────────────────────────────────────────────┤
│  SQLAlchemy ORM                                          │
│  Pydantic 数据验证                                        │
└──────┬───────────────────────────────────────────────────┘
       │
┌──────▼───────────────────┬──────────────────────────────┐
│        数据存储层          │       缓存层                  │
├──────────────────────────┼──────────────────────────────┤
│  PostgreSQL 15           │  Redis 7                     │
│  - 用户数据              │  - 会话缓存                  │
│  - 商品数据              │  - 热点商品缓存              │
│  - 订单数据              │  - 拼团状态缓存              │
│  - 积分数据              │  - 活动弹窗缓存              │
│  - 活动数据              │  - 验证码缓存                │
└──────────────────────────┴──────────────────────────────┘
       │
┌──────▼───────────────────────────────────────────────────┐
│                    外部服务层                              │
├───────────────────────────────────────────────────────────┤
│  微信小程序 API  │  微信支付 API  │  OSS对象存储         │
└───────────────────────────────────────────────────────────┘
```

### 1.2 技术选型说明

#### 前端技术栈

**用户端/商家端小程序**
- **框架**: Taro 3.x（支持多端编译）
- **UI库**: TDesign小程序组件库
- **状态管理**: Zustand
- **HTTP客户端**: Taro.request封装
- **优势**: 一次编写，多端运行；组件丰富，文档完善

**PC后台管理系统**
- **框架**: Vue 3.x
- **UI库**: Element Plus
- **状态管理**: Pinia
- **路由**: Vue Router 4.x
- **HTTP客户端**: Axios
- **优势**: 生态成熟，组件丰富，开发效率高

#### 后端技术栈

**应用框架**
- **框架**: FastAPI 0.104+
- **优势**:
  - 高性能异步框架（基于Starlette和Pydantic）
  - 自动生成OpenAPI文档
  - 类型提示和数据验证
  - 支持WebSocket和异步任务

**数据库**
- **主库**: PostgreSQL 15
- **优势**:
  - 开源、稳定、性能优秀
  - 支持复杂查询和事务
  - JSON字段支持灵活数据结构
  - 适合电商场景

**缓存**
- **Redis** 7
- **用途**:
  - 会话存储
  - 热点数据缓存
  - 拼团状态管理
  - 分布式锁
  - 消息队列（可选）

**ORM**
- **SQLAlchemy** 2.0+
- **异步支持**: SQLAlchemy 2.0原生异步
- **优势**: 功能强大、生态成熟

#### 部署技术栈

- **Web服务器**: Nginx
- **进程管理**: Gunicorn + Uvicorn workers
- **容器化**: Docker + Docker Compose
- **CI/CD**: GitHub Actions / GitLab CI

## 二、微服务划分

### 2.1 服务拆分原则
- 按业务领域拆分（DDD领域驱动）
- 单一职责原则
- 高内聚低耦合
- 独立部署和扩展

### 2.2 核心服务模块

#### 用户服务 (user-service)
- 用户注册/登录
- 用户信息管理
- 地址管理
- 签到功能
- 用户认证授权

#### 商品服务 (product-service)
- 商品CRUD
- 商品分类管理
- 商品搜索/筛选
- 库存管理
- 推荐商品/热卖商品/拼团商品配置

#### 订单服务 (order-service)
- 订单创建
- 订单状态管理
- 订单查询
- 订单统计
- 退款处理

#### 支付服务 (payment-service)
- 微信支付统一下单
- 支付结果回调
- 支付状态查询
- 退款处理
- 对账

#### 配送服务 (delivery-service)
- 配送小区管理
- 自提点管理
- 配送时间配置
- 配送费用计算
- 配送路线规划

#### 积分服务 (points-service)
- 积分规则配置
- 签到积分发放
- 订单积分计算
- 积分明细查询
- 积分兑换

#### 活动服务 (activity-service)
- 活动弹窗配置
- 活动展示逻辑
- 优惠券管理
- 拼团活动管理
- 促销活动管理

#### 消息服务 (message-service)
- 模板消息推送
- 短信通知
- 站内消息

## 三、数据流向

### 3.1 用户下单流程数据流

```
用户端小程序 → 商品服务（查询商品） → PostgreSQL
            → 配送服务（获取配送费/时间） → PostgreSQL
            → 活动服务（获取可用优惠券） → PostgreSQL/Redis
            → 订单服务（创建订单） → PostgreSQL
            → 支付服务（发起支付） → 微信支付API
            → 支付回调 → 支付服务（更新支付状态） → PostgreSQL
            → 订单服务（更新订单状态） → PostgreSQL
            → 消息服务（通知用户/商家） → 微信小程序API
```

### 3.2 拼团流程数据流

```
用户端小程序 → 活动服务（发起拼团） → PostgreSQL
            → Redis（缓存拼团状态）
            → 分享邀请 → 好友参与拼团 → 活动服务
            → 拼团状态判断 → 订单服务（创建订单）
            → 支付服务 → 微信支付
            → 拼团成功/失败 → 消息服务（通知所有参与者）
```

### 3.3 积分流程数据流

```
用户签到 → 积分服务（发放积分） → PostgreSQL
        → Redis（更新用户积分缓存）
        → 消息服务（通知用户）

订单完成 → 订单服务（通知积分服务） → 积分服务（计算积分）
        → PostgreSQL（记录积分明细） → Redis（更新积分缓存）
```

## 四、接口设计原则

### 4.1 RESTful API规范
- 使用HTTP动词：GET、POST、PUT、DELETE
- 资源名词复数形式
- 版本号管理：/api/v1/
- 统一响应格式

### 4.2 统一响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1640000000
}
```

### 4.3 错误码规范
- 200: 成功
- 400: 请求参数错误
- 401: 未授权
- 403: 禁止访问
- 404: 资源不存在
- 500: 服务器内部错误
- 1000-1999: 业务错误码

## 五、安全设计

### 5.1 认证授权
- 用户认证: JWT Token
- 商家认证: JWT Token
- 管理员认证: JWT Token
- Token过期时间: 7天
- 刷新Token机制

### 5.2 数据加密
- 用户密码: bcrypt加密
- 敏感信息: AES加密
- 传输加密: HTTPS

### 5.3 接口安全
- 签名验证（微信支付回调）
- 接口限流（Redis + 滑动窗口）
- SQL注入防护（ORM参数化查询）
- XSS防护（输入输出过滤）

## 六、性能优化

### 6.1 缓存策略
- 商品列表: Redis缓存（TTL 5分钟）
- 商品详情: Redis缓存（TTL 10分钟）
- 用户积分: Redis缓存（TTL 1小时，更新时失效）
- 活动弹窗: Redis缓存（TTL 1小时）
- 拼团状态: Redis实时缓存

### 6.2 数据库优化
- 索引优化（查询字段建立索引）
- 读写分离（主从复制）
- 慢查询优化
- 分表分库（订单表按月分表）

### 6.3 异步处理
- 支付回调异步处理
- 消息推送异步处理
- 数据统计异步计算（Celery）
